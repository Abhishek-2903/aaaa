<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Defense Convoy Management System</title>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <link href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Rajdhani', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #1a2332 0%, #0f1419 50%, #1e2a38 100%);
      color: #e8f4f8;
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
    }
    
    .header {
      grid-row: 1;
      background: linear-gradient(90deg, #2c5530 0%, #1e3a22 50%, #2c5530 100%);
      color: #ffffff;
      padding: 20px;
      text-align: center;
      border-bottom: 3px solid #4a7c59;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 2.5em;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      letter-spacing: 2px;
    }
    
    .main-container {
      grid-row: 2;
      display: flex;
      flex-direction: column;
    }
    
    .control-panel {
      background: rgba(42, 55, 75, 0.95);
      padding: 20px;
      border-bottom: 2px solid #4a7c59;
      backdrop-filter: blur(10px);
    }
    
    .control-panel.hidden {
      display: none;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tab-button {
      background: #2c5530;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .tab-button.active {
      background: #4ade80;
      color: #0f1419;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .panel-section {
      background: rgba(30, 42, 56, 0.8);
      border: 1px solid #4a7c59;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .panel-section h3 {
      margin: 0 0 15px 0;
      color: #4ade80;
      font-size: 1.4em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid #4a7c59;
      padding-bottom: 8px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .form-row > * {
      flex: 1;
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #a5b4c2;
      font-size: 0.95em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #4a7c59;
      border-radius: 4px;
      background: rgba(15, 20, 25, 0.8);
      color: #e8f4f8;
      font-family: 'Rajdhani', sans-serif;
      font-size: 1em;
      box-sizing: border-box;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #4ade80;
      box-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    
    .checkbox-group label {
      margin: 0;
      text-transform: none;
      font-weight: 400;
    }
    
    button {
      background: linear-gradient(135deg, #4a7c59 0%, #2c5530 100%);
      color: #ffffff;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 1em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin: 5px;
    }
    
    button:hover {
      background: linear-gradient(135deg, #5a8c69 0%, #3c6540 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 124, 89, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    button.primary {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: #0f1419;
    }
    
    button.primary:hover {
      background: linear-gradient(135deg, #5eeb95 0%, #32d56e 100%);
    }
    
    button.danger {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    }
    
    button.danger:hover {
      background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
    }
    
    .map-container {
      flex: 1;
      position: relative;
      border: 2px solid #4a7c59;
      border-radius: 8px;
      margin: 0 20px 20px 20px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    #map {
      height: 100%;
      width: 100%;
    }
    
    .status-panel {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(30, 42, 56, 0.95);
      padding: 15px;
      border-radius: 8px;
      z-index: 1000;
      border: 1px solid #4a7c59;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      min-width: 250px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.95em;
    }
    
    .status-label {
      font-weight: 600;
      color: #a5b4c2;
    }
    
    .status-value {
      color: #4ade80;
      font-weight: 600;
    }
    
    .vehicle-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #4a7c59;
      border-radius: 4px;
      background: rgba(15, 20, 25, 0.5);
    }
    
    .vehicle-item {
      padding: 10px;
      border-bottom: 1px solid #4a7c59;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s ease;
    }
    
    .vehicle-item:hover {
      background: rgba(74, 124, 89, 0.2);
    }
    
    .vehicle-item:last-child {
      border-bottom: none;
    }
    
    .mqtt-status {
      padding: 8px 12px;
      border-radius: 4px;
      margin: 10px 0;
      text-align: center;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .mqtt-connected {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: #0f1419;
    }
    
    .mqtt-disconnected {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      color: #ffffff;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1a2332 0%, #0f1419 100%);
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 15px 35px rgba(0,0,0,0.5);
      border: 2px solid #4a7c59;
      transform: scale(0.8);
      transition: transform 0.3s ease;
    }
    
    .modal-overlay.show .modal-content {
      transform: scale(1);
    }
    
    .modal-content h3 {
      margin: 0 0 20px;
      color: #4ade80;
      font-size: 1.6em;
      text-align: center;
    }
    
    .modal-buttons {
      margin-top: 25px;
      text-align: center;
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .coords-inputs {
      display: flex;
      gap: 10px;
    }
    
    .coords-inputs input {
      flex: 1;
    }
    /* Override Leaflet Routing Machine default styles */
.leaflet-control-container .leaflet-routing-container {
  background: rgba(30, 42, 56, 0.95) !important;
  color: #e8f4f8 !important;
  border: 1px solid #4a7c59 !important;
  border-radius: 8px !important;
  padding: 10px !important;
  font-family: 'Rajdhani', sans-serif !important;
  font-size: 1em !important;
  z-index: 1100 !important;
  backdrop-filter: blur(10px) !important;
  max-width: 300px !important;
  max-height: 400px !important;
  overflow-y: auto !important;
}

.leaflet-control-container .leaflet-routing-alt {
  background: rgba(30, 42, 56, 0.95) !important;
  color: #e8f4f8 !important;
  border-bottom: none !important;
  padding: 8px !important;
  margin: 0 !important;
}

.leaflet-control-container .leaflet-routing-alt table {
  background: rgba(15, 20, 25, 0.8) !important;
  color: #e8f4f8 !important;
  border: 1px solid #4a7c59 !important;
  width: 100% !important;
  border-collapse: collapse !important;
}

.leaflet-control-container .leaflet-routing-alt table tr td,
.leaflet-control-container .leaflet-routing-alt table tr th {
  border: 1px solid #4a7c59 !important;
  padding: 8px !important;
  color: #e8f4f8 !important;
  font-weight: 400 !important;
}

.leaflet-control-container .leaflet-routing-alt table tr:hover {
  background: rgba(74, 124, 89, 0.2) !important;
}

.leaflet-control-container .leaflet-routing-alt .instruction {
  font-weight: 600 !important;
  color: #4ade80 !important;
}

.leaflet-control-container .leaflet-routing-container h2,
.leaflet-control-container .leaflet-routing-container h3,
.leaflet-control-container .leaflet-routing-container p,
.leaflet-control-container .leaflet-routing-container li {
  color: white !important;
  font-family: 'Rajdhani', sans-serif !important;
}

.leaflet-control-container .leaflet-routing-geocoders {
  background: rgba(30, 42, 56, 0.95) !important;
  padding: 6px !important;
  border-bottom: none !important;
}

.leaflet-control-container .leaflet-routing-error {
  background: rgba(220, 38, 38, 0.9) !important;
  color: #ffffff !important;
  padding: 6px !important;
  border-bottom: none !important;
}

.leaflet-control-container .leaflet-routing-collapse-btn {
  background: #2c5530 !important;
  color: #ffffff !important;
  border: 1px solid #4a7c59 !important;
  border-radius: 4px !important;
}

.leaflet-control-container .leaflet-routing-collapse-btn:hover {
  background: #4a7c59 !important;
}
    .loading {
      position: relative;
      overflow: hidden;
      opacity: 0.2;
      pointer-events: none;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(74, 222, 128, 0.3), transparent);
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    
    .section-divider {
      height: 2px;
      background: linear-gradient(90deg, transparent, #4a7c59, transparent);
      margin: 20px 0;
    }
    
    .blur {
      filter: blur(5px);
      pointer-events: none;
      transition: filter 0.3s ease;
    }
    
    .map-container-focused {
      z-index: 1000;
      position: relative;
    }
    
    @media (max-width: 768px) {
      .panel-grid {
        grid-template-columns: 1fr;
      }
      .form-row {
        flex-direction: column;
      }
      .action-buttons {
        justify-content: center;
      }
      .status-panel {
        position: relative;
        top: auto;
        right: auto;
        margin: 15px;
      }
      .map-container {
        margin: 0 10px 10px 10px;
      }
      button {
        padding: 8px 16px;
        font-size: 0.9em;
      }
      
      .header {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🎖️ DEFENSE CONVOY MANAGEMENT SYSTEM</h1>
    <button id="toggleControlPanel">Hide Control Panel</button>
  </div>

  <div class="main-container">
    <div class="control-panel">
      <div class="tabs">
        <button class="tab-button active" onclick="ConvoySystem.switchTab('load-route')">Load & Route</button>
        <button class="tab-button" onclick="ConvoySystem.switchTab('vehicles')">Vehicles</button>
        <button class="tab-button" onclick="ConvoySystem.switchTab('convoy')">Convoy Ops</button>
        <button class="tab-button" onclick="ConvoySystem.switchTab('settings')">Settings</button>
      </div>

      <div id="load-route" class="tab-content active">
        <div class="panel-grid">
          <div class="panel-section">
            <h3>🚛 Load Classification</h3>
            <div class="form-group">
              <label for="loadType">Load Category:</label>
              <select id="loadType" onchange="ConvoySystem.toggleLoadInputs()">
                <option value="troops">Troops</option>
                <option value="cargo">Cargo / Supplies</option>
                <option value="fuel">Fuel (POL)</option>
                <option value="ammo">Ammunition</option>
              </select>
            </div>
            <div class="form-group">
              <label for="priority">Priority Level:</label>
              <select id="priority">
                <option value="normal">Normal</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
                <option value="low">Low</option>
              </select>
            </div>
          </div>

          <div class="panel-section">
            <h3>🗺️ Route Planning</h3>
            <div class="form-group">
              <label>Origin:</label>
              <input type="text" id="startLocation" placeholder="Location name">
              <div class="coords-inputs">
                <input type="number" id="startLat" placeholder="Latitude" step="any">
                <input type="number" id="startLng" placeholder="Longitude" step="any">
              </div>
            </div>
            <div class="form-group">
              <label>Destination:</label>
              <input type="text" id="endLocation" placeholder="Location name">
              <div class="coords-inputs">
                <input type="number" id="endLat" placeholder="Latitude" step="any">
                <input type="number" id="endLng" placeholder="Longitude" step="any">
              </div>
            </div>
            <div class="form-group">
              <label for="vehicleSpeed">Convoy Speed (km/h):</label>
              <input type="number" id="vehicleSpeed" value="40" min="20" max="80">
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="markTcp" onchange="ConvoySystem.toggleTcpMarker()">
              <label for="markTcp">Mark TCP Locations</label>
            </div>
          </div>
        </div>

        <div id="troopSection" class="panel-section">
          <h3>👥 Troop Details</h3>
          <div class="form-row">
            <div>
              <label for="soldierCount">Personnel Count:</label>
              <input type="number" id="soldierCount" placeholder="Enter count" min="0">
            </div>
            <div>
              <label for="gearLoad">Equipment Load:</label>
              <select id="gearLoad">
                <option value="light">Light (Personal kit only)</option>
                <option value="medium">Medium (Combat load)</option>
                <option value="heavy">Heavy (Full battle order)</option>
              </select>
            </div>
            <div>
              <label for="vehiclePreference">Preferred Transport:</label>
              <select id="vehiclePreference">
                <option value="bus">Bus</option>
                <option value="truck">Truck</option>
                <option value="troopCarrier">Troop Carrier</option>
              </select>
            </div>
          </div>
        </div>

        <div id="cargoSection" class="panel-section" style="display:none">
          <h3>📦 Cargo Specifications</h3>
          <div class="form-row">
            <div>
              <label for="boxCount">Number of Units:</label>
              <input type="number" id="boxCount" min="0">
            </div>
            <div>
              <label for="boxWeight">Weight per Unit (kg):</label>
              <input type="number" id="boxWeight" min="0">
            </div>
          </div>
          <div class="form-group">
            <label>Dimensions (cm):</label>
            <div class="form-row">
              <input type="number" id="boxLength" placeholder="Length" min="0">
              <input type="number" id="boxWidth" placeholder="Width" min="0">
              <input type="number" id="boxHeight" placeholder="Height" min="0">
            </div>
          </div>
          <div class="form-row">
            <div class="checkbox-group">
              <input type="checkbox" id="isFragile">
              <label for="isFragile">Fragile</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="isStackable">
              <label for="isStackable">Stackable</label>
            </div>
          </div>
        </div>

        <div id="fuelSection" class="panel-section" style="display:none">
          <h3>⛽ Fuel Details</h3>
          <div class="form-row">
            <div>
              <label for="fuelQuantity">Quantity (liters):</label>
              <input type="number" id="fuelQuantity" min="0">
            </div>
            <div>
              <label for="fuelType">Fuel Type:</label>
              <select id="fuelType">
                <option value="diesel">Diesel</option>
                <option value="petrol">Petrol</option>
                <option value="aviation">Aviation Fuel</option>
              </select>
            </div>
          </div>
        </div>

        <div id="ammoSection" class="panel-section" style="display:none">
          <h3>💥 Ammunition Details</h3>
          <div class="form-row">
            <div>
              <label for="ammoType">Ammunition Type:</label>
              <input type="text" id="ammoType" placeholder="e.g., 5.56mm, 7.62mm">
            </div>
            <div>
              <label for="ammoQuantity">Quantity:</label>
              <input type="number" id="ammoQuantity" min="0">
            </div>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="isExplosive">
            <label for="isExplosive">Explosive</label>
          </div>
        </div>
      </div>

      <div id="vehicles" class="tab-content">
        <div class="panel-grid">
          <div class="panel-section">
            <h3>🚗 Vehicle Assets</h3>
            <div class="mqtt-status" id="mqttStatus">
              <span class="mqtt-disconnected">MQTT: Disconnected</span>
            </div>
            <div class="action-buttons">
              <button onclick="ConvoySystem.refreshVehicles()">Refresh Vehicles</button>
              <button onclick="ConvoySystem.showTransitCamps()">Transit Camps</button>
              <button onclick="ConvoySystem.showCheckpoints()">TCPs</button>
            </div>
            <div id="vehicleList" class="vehicle-list">
              <div class="vehicle-item">No vehicles connected</div>
            </div>
          </div>

          <div class="panel-section">
            <h3>🔧 Manual Vehicle Registration</h3>
            <div class="form-row">
              <div>
                <input type="text" id="vehicleId" placeholder="Vehicle ID">
              </div>
              <div>
                <select id="vehicleType">
                  <option value="bus">Bus</option>
                  <option value="truck">Truck</option>
                  <option value="troop_carrier">Troop Carrier</option>
                  <option value="fuel_tanker">Fuel Tanker</option>
                  <option value="armored_truck">Armored Truck</option>
                  <option value="police_van">Police Van</option>
                </select>
              </div>
              <div>
                <input type="number" id="vehicleCapacity" placeholder="Capacity" min="0">
              </div>
              <div>
                <select id="ownership">
                  <option value="military">Military</option>
                  <option value="civilian">Civilian</option>
                </select>
              </div>
            </div>
            <div class="coords-inputs">
              <input type="number" id="vehicleLat" placeholder="Latitude" step="any">
              <input type="number" id="vehicleLng" placeholder="Longitude" step="any">
            </div>
            <button onclick="ConvoySystem.registerVehicle()">Register Vehicle</button>
          </div>
        </div>
      </div>

      <div id="convoy" class="tab-content">
        <div class="panel-section">
          <h3>⚙️ Convoy Operations</h3>
          <div class="form-row">
            <div>
              <label for="roadType">Road Type:</label>
              <select id="roadType">
                <option value="mountain">Mountain Road</option>
                <option value="plains">Plains Highway</option>
                <option value="urban">Urban Route</option>
              </select>
            </div>
            <div>
              <label for="convoyId">Convoy ID:</label>
              <input type="text" id="convoyId" placeholder="Convoy ID">
            </div>
          </div>
          <div class="action-buttons">
            <button onclick="ConvoySystem.calculateVTKM()">Calculate VTKM</button>
            <button onclick="ConvoySystem.getConvoyTimeline()">Get Timeline</button>
            <button onclick="ConvoySystem.suggestConvoyLayout()">Suggest Layout</button>
          </div>
          <div id="convoyList">
            <p>No active convoys</p>
          </div>
        </div>
      </div>

      <div id="settings" class="tab-content">
        <div class="panel-section">
          <h3>⚙️ System Configuration</h3>
          <div class="form-row">
            <div>
              <label for="mqttBroker">MQTT Broker:</label>
              <input type="text" id="mqttBroker" placeholder="MQTT Broker Address" value="wss://broker.hivemq.com">
            </div>
            <div>
              <label for="mqttPort">Port:</label>
              <input type="number" id="mqttPort" placeholder="Port" value="8884">
            </div>
            <div>
              <label for="mqttTopic">Base Topic:</label>
              <input type="text" id="mqttTopic" placeholder="Base Topic" value="vehicles">
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="defaultSpeed">Default Speed (km/h):</label>
              <input type="number" id="defaultSpeed" value="40" min="20" max="80">
            </div>
            <div>
              <label for="safetyDistance">Safety Distance (m):</label>
              <input type="number" id="safetyDistance" value="50" min="10">
            </div>
          </div>
          <div class="form-row">
            <div>
              <input type="text" id="mqttUsername" placeholder="Username (optional)">
            </div>
            <div>
              <input type="password" id="mqttPassword" placeholder="Password (optional)">
            </div>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="showTraffic" onchange="ConvoySystem.toggleTrafficLayer()">
            <label for="showTraffic">Show Traffic Layer</label>
          </div>
          <div class="action-buttons">
            <button class="primary" onclick="ConvoySystem.connectMQTT()">Connect MQTT</button>
            <button onclick="ConvoySystem.saveSettings()">Save Settings</button>
          </div>
        </div>
      </div>

      <div class="section-divider"></div>
      <div class="action-buttons" style="justify-content: center;">
        <button class="primary" onclick="ConvoySystem.submitLoadRequest()">Process Load Request</button>
        <button onclick="ConvoySystem.optimizeAllocation()">Optimize Allocation</button>
        <button onclick="ConvoySystem.generateMovementInstructions()">Generate Instructions</button>
        <button onclick="ConvoySystem.addTransitCamp()">Add Transit Camp</button>
        <button onclick="ConvoySystem.addCheckpoint()">Add TCP</button>
      </div>
    </div>

    <div class="map-container">
      <div class="status-panel">
        <div class="status-item">
          <span class="status-label">System Status:</span>
          <span class="status-value" id="systemStatus">Initializing...</span>
        </div>
        <div class="status-item">
          <span class="status-label">Active Vehicles:</span>
          <span class="status-value" id="activeVehicleCount">0</span>
        </div>
        <div class="status-item">
          <span class="status-label">Last Update:</span>
          <span class="status-value" id="lastUpdate">--:--</span>
        </div>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <div id="resultModal" class="modal-overlay">
    <div class="modal-content">
      <div id="resultContent"></div>
      <div class="modal-buttons">
        <button class="primary" onclick="ConvoySystem.confirmConvoy(true)">✓ Agree</button>
        <button class="danger" onclick="ConvoySystem.confirmConvoy(false)">✗ Disagree</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/mqtt@5.7.1/dist/mqtt.min.js"></script>
  <script>
    const ConvoySystem = {
      map: null,
      routeControl: null,
      vehicleMarkers: {},
      tcpMarkers: [],
      transitCampMarkers: [],
      mqttClient: null,
      mqttConnected: false,
      activeRequests: [],
      trafficLayer: null,
      baseLayers: null,
      overlayLayers: null,
      currentBaseLayer: null,
      suggestedConvoy: null,
      routeCoordinates: [],

      initMap() {
        try {
          const startLat = parseFloat(document.getElementById('startLat').value);
    const startLng = parseFloat(document.getElementById('startLng').value);
    // Default coordinates (Delhi) if inputs are invalid or empty
    const center = (!isNaN(startLat) && !isNaN(startLng) && startLat !== '' && startLng !== '') 
      ? [startLat, startLng] 
      : [28.6139, 77.2090];
    // Initialize map with zoom level 17
    this.map = L.map('map').setView(center, 17);
          const baseLayers = {
            'Streets': L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
              maxZoom: 20,
              subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
              attribution: '© Google Maps'
            }),
            'Satelite': L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
              maxZoom: 20,
              subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
              attribution: '© Google Maps'
            }),
            
            'Terrain': L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
              maxZoom: 20,
              subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
              attribution: '© Google Maps'
            })
          };

          baseLayers.Streets.addTo(this.map);
          this.currentBaseLayer = baseLayers.Streets;

          this.overlayLayers = {
            'Traffic': L.tileLayer('https://{s}.google.com/vt/lyrs=m@221097413,traffic&x={x}&y={y}&z={z}', {
              maxZoom: 20,
              minZoom: 2,
              subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
              attribution: 'Traffic data © Google Maps',
              opacity: 0.7,
              errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQImWP4//8/AwPD/////z8DAIEAFHEDO68AAAAASUVORK5CYII=',
              tileerror: (tile, error) => {
                console.warn('Traffic tile loading error:', error, tile.src);
                alert('Traffic data failed to load. Check console for details or consider using a Google Maps API key.');
              }
            })
          };

          this.baseLayers = baseLayers;
          L.control.layers(baseLayers, this.overlayLayers).addTo(this.map);

          this.trafficLayer = this.overlayLayers.Traffic;
          document.getElementById('showTraffic').checked = false;

          this.map.on('baselayerchange', (e) => {
            this.currentBaseLayer = e.layer;
            if (document.getElementById('showTraffic').checked) {
              this.toggleTrafficLayer();
            }
          });

          this.trafficLayer.on('tileerror', (error, tile) => {
            console.warn('Traffic tile error:', error, tile.src);
          });
        } catch (error) {
          console.error('Map initialization error:', error);
          alert('Failed to initialize map');
        }
      },

      toggleTrafficLayer() {
        try {
          const showTraffic = document.getElementById('showTraffic').checked;
          if (showTraffic) {
            if (this.map.hasLayer(this.trafficLayer)) {
              this.map.removeLayer(this.trafficLayer);
            }
            this.trafficLayer.addTo(this.map);
            this.trafficLayer.bringToFront();
          } else {
            if (this.map.hasLayer(this.trafficLayer)) {
              this.map.removeLayer(this.trafficLayer);
            }
          }
        } catch (error) {
          console.error('Toggle traffic layer error:', error);
          alert('Failed to toggle traffic layer. Check console for details.');
        }
      },

      switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
          content.style.display = 'none';
        });
        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
        const activeTab = document.getElementById(tabId);
        if (activeTab) {
          activeTab.classList.add('active');
          activeTab.style.display = 'block';
        }
        document.querySelector(`.tab-button[onclick="ConvoySystem.switchTab('${tabId}')"]`).classList.add('active');
        this.map.invalidateSize();
      },

      toggleLoadInputs() {
        try {
          const type = document.getElementById('loadType').value;
          document.getElementById('troopSection').style.display = type === 'troops' ? 'block' : 'none';
          document.getElementById('cargoSection').style.display = type === 'cargo' ? 'block' : 'none';
          document.getElementById('fuelSection').style.display = type === 'fuel' ? 'block' : 'none';
          document.getElementById('ammoSection').style.display = type === 'ammo' ? 'block' : 'none';
        } catch (error) {
          console.error('Toggle load inputs error:', error);
        }
      },

      toggleTcpMarker() {
        try {
          if (document.getElementById('markTcp').checked) {
            this.map.on('click', (e) => {
              if (this.tcpMarker) this.map.removeLayer(this.tcpMarker);
              this.tcpMarker = L.marker(e.latlng, {
                icon: L.icon({
                  iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#f00" stroke-width="2"><path d="M5 10h14l2-4H3l2 4zM5 10v4h14v-4M5 14l-2 4h18l-2-4M6 18a1 1 0 110-2 1 1 0 010 2zm12 0a1 1 0 110-2 1 1 0 010 2zM9 10l-1-4h8l-1 4"/></svg>'),
                  iconSize: [25, 25],
                  className: 'bounce'
                })
              }).addTo(this.map).bindPopup(`TCP Marker<br>Lat: ${e.latlng.lat.toFixed(4)}, Lng: ${e.latlng.lng.toFixed(4)}`).openPopup();
            });
          } else {
            this.map.off('click');
            if (this.tcpMarker) this.map.removeLayer(this.tcpMarker);
          }
        } catch (error) {
          console.error('TCP marker error:', error);
        }
      },

      async geocode(location) {
        try {
          if (!location || typeof location !== 'string') throw new Error('Invalid location');
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`);
          const data = await response.json();
          if (!data.length) throw new Error('Location not found: ' + location);
          return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
        } catch (error) {
          throw new Error('Geocoding error: ' + error.message);
        }
      },

      async getCoordinates(name, lat, lng) {
        try {
          if (!isNaN(lat) && !isNaN(lng) && lat !== '' && lng !== '') {
            return [parseFloat(lat), parseFloat(lng)];
          }
          if (name && name.trim()) {
            return await this.geocode(name.trim());
          }
          throw new Error('Please enter either location name or coordinates');
        } catch (error) {
          throw error;
        }
      },

      async submitLoadRequest() {
        const button = document.querySelector('.primary');
        try {
          button.disabled = true;
          button.classList.add('loading');

          document.querySelector('.header').classList.add('blur');
          document.querySelector('.control-panel').classList.add('blur');
          document.querySelector('.map-container').classList.add('map-container-focused');

          const loadType = document.getElementById('loadType').value;
          let priority = document.getElementById('priority').value;
          const vehicleSpeed = parseFloat(document.getElementById('vehicleSpeed').value) || 40;

          if (vehicleSpeed < 20 || vehicleSpeed > 80) throw new Error('Invalid speed (20-80 km/h)');

          const startCoords = await this.getCoordinates(
            document.getElementById('startLocation').value,
            document.getElementById('startLat').value,
            document.getElementById('startLng').value
          );
          const endCoords = await this.getCoordinates(
            document.getElementById('endLocation').value,
            document.getElementById('endLat').value,
            document.getElementById('endLng').value
          );

          priority = this.adjustPriority(loadType, priority);

          const payload = { loadType, priority, startCoords, endCoords, vehicleSpeed };

          if (loadType === 'troops') {
            payload.soldierCount = parseInt(document.getElementById('soldierCount').value) || 0;
            payload.gearLoad = document.getElementById('gearLoad').value;
            payload.vehiclePreference = document.getElementById('vehiclePreference').value;
            if (payload.soldierCount <= 0) throw new Error('Invalid personnel count');
          } else if (loadType === 'cargo') {
            payload.boxCount = parseInt(document.getElementById('boxCount').value) || 0;
            payload.boxLength = parseFloat(document.getElementById('boxLength').value) || 0;
            payload.boxWidth = parseFloat(document.getElementById('boxWidth').value) || 0;
            payload.boxHeight = parseFloat(document.getElementById('boxHeight').value) || 0;
            payload.boxWeight = parseFloat(document.getElementById('boxWeight').value) || 0;
            payload.isFragile = document.getElementById('isFragile').checked;
            payload.isStackable = document.getElementById('isStackable').checked;
            if (payload.boxCount <= 0) throw new Error('Invalid box count');
          } else if (loadType === 'fuel') {
            payload.fuelQuantity = parseFloat(document.getElementById('fuelQuantity').value) || 0;
            payload.fuelType = document.getElementById('fuelType').value;
            if (payload.fuelQuantity <= 0) throw new Error('Invalid fuel quantity');
          } else if (loadType === 'ammo') {
            payload.ammoType = document.getElementById('ammoType').value;
            payload.ammoQuantity = parseInt(document.getElementById('ammoQuantity').value) || 0;
            payload.isExplosive = document.getElementById('isExplosive').checked;
            if (!payload.ammoType || payload.ammoQuantity <= 0) throw new Error('Invalid ammunition details');
          }

          const response = await fetch('http://localhost:8000/assign-vehicles/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
          const result = await response.json();

          this.activeRequests.push({
            id: Date.now(),
            payload,
            result,
            timestamp: new Date().toISOString()
          });

          this.displayResult(result, startCoords);
          this.drawRoute(startCoords, endCoords, vehicleSpeed, result);
          this.map.invalidateSize();
        } catch (error) {
          alert('Error: ' + error.message);
          console.error('Submit load request error:', error);
        } finally {
          button.disabled = false;
          button.classList.remove('loading');
        }
      },

      adjustPriority(loadType, userPriority) {
        const priorityMap = {
          'ammo': 'critical',
          'fuel': 'high',
          'troops': 'high',
          'cargo': 'normal'
        };
        return priorityMap[loadType] || userPriority;
      },

      displayResult(result, startCoords) {
        try {
          const escapeHTML = str => str.replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
          })[m]);

          let message = `
            <h3>Load Assignment Result</h3>
            <p><strong>Priority:</strong> ${escapeHTML(result.priority || 'N/A')}</p>
            <p><strong>Vehicles Required:</strong> ${escapeHTML(result.vehiclesRequired?.toString() || 'N/A')}</p>
            <p><strong>Recommended Vehicle Type:</strong> ${escapeHTML(result.recommendedVehicleType || 'N/A')}</p>
          `;

          if (result.specialHandling) {
            message += `<p><strong>Special Handling:</strong> ${escapeHTML(result.specialHandling)}</p>`;
          }

          if (result.routeAnalysis) {
            message += `
              <h4>Route Analysis</h4>
              <p><strong>Distance:</strong> ${escapeHTML(result.routeAnalysis.distance_km?.toString())} km</p>
              <p><strong>Estimated Time:</strong> ${escapeHTML(result.routeAnalysis.estimated_time_hours?.toString())} hours</p>
              <p><strong>Fuel Consumption:</strong> ${escapeHTML(result.routeAnalysis.fuel_consumption_estimate?.toString())} liters</p>
            `;
          }

          message += `<p><strong>Do you agree with the suggested convoy formation?</strong></p>`;

          const modal = document.getElementById('resultModal');
          const content = document.getElementById('resultContent');
          content.innerHTML = message;
          modal.classList.add('show');
          
          this.suggestedConvoy = {
            vehiclesRequired: result.vehiclesRequired || 4,
            vehicleType: result.recommendedVehicleType || 'truck',
            startCoords,
            result
          };
        } catch (error) {
          console.error('Display result error:', error);
        }
      },

      confirmConvoy(agreed) {
  try {
    const modal = document.getElementById('resultModal');
    modal.classList.remove('show');

    document.querySelector('.header').classList.remove('blur');
    document.querySelector('.control-panel').classList.remove('blur');
    document.querySelector('.map-container').classList.remove('map-container-focused');

    if (agreed && this.suggestedConvoy) {
      const controlPanel = document.querySelector('.control-panel');
      controlPanel.classList.add('hidden');
      document.getElementById('toggleControlPanel').textContent = 'Show Control Panel';
      this.displayConvoyOnRoute();
      this.sendNotifications(this.suggestedConvoy.result);
      // Re-center map on start coordinates at zoom 17
      this.map.setView(this.suggestedConvoy.startCoords, 15);
    }
    this.map.invalidateSize();
  } catch (error) {
    console.error('Confirm convoy error:', error);
  }
},

      displayConvoyOnRoute() {
        try {
          if (!this.routeCoordinates.length) {
            alert('Route not found. Please ensure the route is calculated.');
            return;
          }

          const { vehiclesRequired, vehicleType } = this.suggestedConvoy;
          const safetyDistance = parseInt(document.getElementById('safetyDistance').value) || 50;

          const totalConvoyLength = (vehiclesRequired + 1) * safetyDistance;

          let routeLength = 0;
          for (let i = 1; i < this.routeCoordinates.length; i++) {
            routeLength += this.routeCoordinates[i - 1].distanceTo(this.routeCoordinates[i]);
          }

          if (totalConvoyLength > routeLength) {
            alert('Convoy length exceeds route length. Adjusting to fit.');
          }

          const positions = this.calculatePositionsAlongRoute(totalConvoyLength, vehiclesRequired + 2);
// Police Van Front - More realistic design with emergency lights
// Police Van Front - More realistic design with emergency lights
const policeFront = L.marker(positions[0], {
  icon: L.icon({
    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
        <!-- Shadow -->
        <ellipse cx="24" cy="44" rx="20" ry="3" fill="#00000020"/>
        
        <!-- Main body -->
        <rect x="6" y="18" width="36" height="20" rx="2" fill="#1e40af" stroke="#1e3a8a" stroke-width="1"/>
        
        <!-- Front windshield -->
        <path d="M6 18 L10 12 L38 12 L42 18 Z" fill="#87ceeb" stroke="#1e3a8a" stroke-width="1"/>
        
        <!-- Side windows -->
        <rect x="8" y="20" width="6" height="8" rx="1" fill="#87ceeb"/>
        <rect x="34" y="20" width="6" height="8" rx="1" fill="#87ceeb"/>
        
        <!-- Wheels -->
        <circle cx="14" cy="38" r="4" fill="#2d3748" stroke="#1a202c" stroke-width="1"/>
        <circle cx="34" cy="38" r="4" fill="#2d3748" stroke="#1a202c" stroke-width="1"/>
        <circle cx="14" cy="38" r="2" fill="#4a5568"/>
        <circle cx="34" cy="38" r="2" fill="#4a5568"/>
        
        <!-- Emergency lights -->
        <rect x="16" y="14" width="4" height="2" rx="1" fill="#ff0000"/>
        <rect x="22" y="14" width="4" height="2" rx="1" fill="#0000ff"/>
        <rect x="28" y="14" width="4" height="2" rx="1" fill="#ff0000"/>
        
        <!-- Police text -->
        <rect x="16" y="24" width="16" height="6" rx="1" fill="#ffffff"/>
        <text x="24" y="28" text-anchor="middle" font-family="Arial" font-size="6" font-weight="bold" fill="#1e40af">POLICE</text>
        
        <!-- Front grille -->
        <rect x="6" y="30" width="2" height="8" rx="1" fill="#374151"/>
        <rect x="40" y="30" width="2" height="8" rx="1" fill="#374151"/>
        
        <!-- Door handles -->
        <circle cx="18" cy="26" r="1" fill="#374151"/>
        <circle cx="30" cy="26" r="1" fill="#374151"/>
      </svg>
    `),
    iconSize: [48, 48],
    iconAnchor: [24, 44],
    popupAnchor: [0, -44],
    className: 'bounce'
  })
}).bindPopup('Police Van (Front)').addTo(this.map);

// Vehicle markers (Bus or Car) - Dynamic based on type
for (let i = 1; i <= vehiclesRequired; i++) {
  const isBus = vehicleType.toLowerCase() === 'bus';
  const marker = L.marker(positions[i], {
    icon: L.icon({
      iconUrl: 'data:image/svg+xml;base64,' + btoa(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
          <!-- Shadow -->
          <ellipse cx="24" cy="44" rx="${isBus ? '22' : '18'}" ry="3" fill="#00000020"/>
          
          ${isBus ? `
          <!-- Bus Body (longer and taller) -->
          <rect x="2" y="12" width="44" height="22" rx="2" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
          
          <!-- Front nose -->
          <rect x="2" y="20" width="4" height="14" rx="2" fill="#f59e0b"/>
          <rect x="2" y="22" width="2" height="10" rx="1" fill="#374151"/>
          
          <!-- Large front windshield -->
          <rect x="6" y="14" width="8" height="12" rx="1" fill="#87ceeb" stroke="#1e40af" stroke-width="0.5"/>
          
          <!-- Multiple side windows (bus-like) -->
          <rect x="16" y="16" width="5" height="8" rx="1" fill="#87ceeb"/>
          <rect x="22" y="16" width="5" height="8" rx="1" fill="#87ceeb"/>
          <rect x="28" y="16" width="5" height="8" rx="1" fill="#87ceeb"/>
          <rect x="34" y="16" width="5" height="8" rx="1" fill="#87ceeb"/>
          <rect x="40" y="16" width="4" height="8" rx="1" fill="#87ceeb"/>
          
          <!-- Bus door (wide folding door) -->
          <rect x="14" y="26" width="8" height="8" rx="1" fill="#374151" stroke="#1f2937" stroke-width="1"/>
          <line x1="18" y1="26" x2="18" y2="34" stroke="#1f2937" stroke-width="1"/>
          <rect x="15" y="28" width="2" height="4" rx="0.5" fill="#87ceeb"/>
          <rect x="19" y="28" width="2" height="4" rx="0.5" fill="#87ceeb"/>
          
          <!-- Emergency exit -->
          <rect x="36" y="26" width="6" height="6" rx="1" fill="#87ceeb" stroke="#f59e0b" stroke-width="1"/>
          <text x="39" y="30" text-anchor="middle" font-family="Arial" font-size="3" fill="#ff0000">EXIT</text>
          
          <!-- Large bus wheels -->
          <circle cx="10" cy="34" r="5" fill="#2d3748" stroke="#1a202c" stroke-width="1"/>
          <circle cx="38" cy="34" r="5" fill="#2d3748" stroke="#1a202c" stroke-width="1"/>
          <circle cx="10" cy="34" r="3" fill="#4a5568"/>
          <circle cx="38" cy="34" r="3" fill="#4a5568"/>
          
          <!-- Front destination sign -->
          <rect x="6" y="16" width="6" height="3" rx="0.5" fill="#000000"/>
          <text x="9" y="18.5" text-anchor="middle" font-family="Arial" font-size="2" fill="#00ff00">BUS ${i}</text>
          
          <!-- Side destination sign -->
          <rect x="16" y="26" width="16" height="2" rx="0.5" fill="#000000"/>
          <text x="24" y="27.5" text-anchor="middle" font-family="Arial" font-size="2" fill="#00ff00">BUS ROUTE ${i}</text>
          
          <!-- Bus headlights -->
          <circle cx="3" cy="24" r="1.5" fill="#ffffcc"/>
          <circle cx="3" cy="28" r="1.5" fill="#ffffcc"/>
          
          <!-- Side mirrors -->
          <rect x="6" y="18" width="2" height="1" rx="0.5" fill="#374151"/>
          <rect x="44" y="18" width="2" height="1" rx="0.5" fill="#374151"/>
          
          <!-- Roof equipment (air conditioning) -->
          <rect x="20" y="12" width="12" height="2" rx="1" fill="#9ca3af"/>
          <rect x="22" y="11" width="8" height="1" rx="0.5" fill="#6b7280"/>
          
          ` : `
          <!-- Car Body -->
          <rect x="8" y="20" width="32" height="16" rx="2" fill="#3b82f6" stroke="#1e40af" stroke-width="1"/>
          
          <!-- Car roof -->
          <path d="M12 20 L16 14 L32 14 L36 20 Z" fill="#1e40af" stroke="#1e3a8a" stroke-width="1"/>
          
          <!-- Windows -->
          <path d="M14 20 L17 15 L31 15 L34 20 Z" fill="#87ceeb"/>
          <rect x="10" y="22" width="5" height="6" rx="1" fill="#87ceeb"/>
          <rect x="33" y="22" width="5" height="6" rx="1" fill="#87ceeb"/>
          
          <!-- Wheels -->
          <circle cx="16" cy="36" r="4" fill="#2d3748" stroke="#1a202c" stroke-width="1"/>
          <circle cx="32" cy="36" r="4" fill="#2d3748" stroke="#1a202c" stroke-width="1"/>
          <circle cx="16" cy="36" r="2" fill="#4a5568"/>
          <circle cx="32" cy="36" r="2" fill="#4a5568"/>
          
          <!-- Headlights -->
          <circle cx="8" cy="24" r="2" fill="#ffffcc"/>
          <circle cx="40" cy="24" r="2" fill="#ffffcc"/>
          
          <!-- Door handles -->
          <circle cx="18" cy="26" r="1" fill="#1e40af"/>
          <circle cx="30" cy="26" r="1" fill="#1e40af"/>
          `}
        </svg>
      `),
      iconSize: [48, 48],
      iconAnchor: [24, 44],
      popupAnchor: [0, -44],
      className: 'bounce'
    })
  }).bindPopup(`${vehicleType} #${i}`).addTo(this.map);
}

// Police Van Rear - Mirror of front van
const policeRear = L.marker(positions[positions.length - 1], {
  icon: L.icon({
    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
        <!-- Shadow -->
        <ellipse cx="24" cy="44" rx="20" ry="3" fill="#00000020"/>
        
        <!-- Main body -->
        <rect x="6" y="18" width="36" height="20" rx="2" fill="#1e40af" stroke="#1e3a8a" stroke-width="1"/>
        
        <!-- Rear windshield -->
        <rect x="8" y="20" width="32" height="8" rx="1" fill="#87ceeb"/>
        
        <!-- Side windows -->
        <rect x="8" y="30" width="6" height="6" rx="1" fill="#87ceeb"/>
        <rect x="34" y="30" width="6" height="6" rx="1" fill="#87ceeb"/>
        
        <!-- Wheels -->
        <circle cx="14" cy="38" r="4" fill="#2d3748" stroke="#1a202c" stroke-width="1"/>
        <circle cx="34" cy="38" r="4" fill="#2d3748" stroke="#1a202c" stroke-width="1"/>
        <circle cx="14" cy="38" r="2" fill="#4a5568"/>
        <circle cx="34" cy="38" r="2" fill="#4a5568"/>
        
        <!-- Emergency lights -->
        <rect x="16" y="14" width="4" height="2" rx="1" fill="#ff0000"/>
        <rect x="22" y="14" width="4" height="2" rx="1" fill="#0000ff"/>
        <rect x="28" y="14" width="4" height="2" rx="1" fill="#ff0000"/>
        
        <!-- Police text -->
        <rect x="16" y="32" width="16" height="4" rx="1" fill="#ffffff"/>
        <text x="24" y="35" text-anchor="middle" font-family="Arial" font-size="5" font-weight="bold" fill="#1e40af">POLICE</text>
        
        <!-- Rear lights -->
        <rect x="6" y="24" width="2" height="4" rx="1" fill="#ff0000"/>
        <rect x="40" y="24" width="2" height="4" rx="1" fill="#ff0000"/>
        
        <!-- Door handles -->
        <circle cx="18" cy="26" r="1" fill="#374151"/>
        <circle cx="30" cy="26" r="1" fill="#374151"/>
        
        <!-- Rear doors -->
        <line x1="24" y1="20" x2="24" y2="36" stroke="#1e3a8a" stroke-width="1"/>
      </svg>
    `),
    iconSize: [48, 48],
    iconAnchor: [24, 44],
    popupAnchor: [0, -44],
    className: 'bounce'
  })
}).bindPopup('Police Van (Rear)').addTo(this.map);




          this.vehicleMarkers = { ...this.vehicleMarkers, policeFront, policeRear };
          this.map.invalidateSize();
        } catch (error) {
          console.error('Display convoy on route error:', error);
        }
      },

      calculatePositionsAlongRoute(totalConvoyLength, vehicleCount) {
        const positions = [];
        const routeLength = this.routeCoordinates.length;
        const distancePerVehicle = totalConvoyLength / (vehicleCount - 1);

        let currentDistance = 0;
        for (let i = 0; i < vehicleCount; i++) {
          const position = this.findPositionOnRoute(currentDistance);
          positions.push(position);
          currentDistance += distancePerVehicle;
        }

        return positions;
      },

      findPositionOnRoute(distance) {
        let accumulatedDistance = 0;
        for (let i = 1; i < this.routeCoordinates.length; i++) {
          const segmentDistance = this.routeCoordinates[i - 1].distanceTo(this.routeCoordinates[i]);
          if (accumulatedDistance + segmentDistance >= distance) {
            const ratio = (distance - accumulatedDistance) / segmentDistance;
            const lat = this.routeCoordinates[i - 1].lat + ratio * (this.routeCoordinates[i].lat - this.routeCoordinates[i - 1].lat);
            const lng = this.routeCoordinates[i - 1].lng + ratio * (this.routeCoordinates[i].lng - this.routeCoordinates[i - 1].lng);
            return L.latLng(lat, lng);
          }
          accumulatedDistance += segmentDistance;
        }
        return this.routeCoordinates[this.routeCoordinates.length - 1];
      },

      drawRoute(startCoords, endCoords, speed, result) {
        try {
          if (this.routeControl) {
            this.map.removeControl(this.routeControl);
          }

          this.routeControl = L.Routing.control({
            waypoints: [
              L.latLng(startCoords[0], startCoords[1]),
              L.latLng(endCoords[0], endCoords[1])
            ],
            lineOptions: {
              styles: [{
                color: result.priority === 'critical' ? 'red' :
                      result.priority === 'high' ? 'orange' : '#0f0',
                weight: 6,
                opacity: 0.8
              }]
            },
            routeWhileDragging: false,
            createMarker: (i, waypoint) => {
              return L.marker(waypoint.latLng, {
                icon: L.icon({
                  iconUrl: 'data:image/svg+xml;base64,' + btoa(
                    `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${i === 0 ? '#0f0' : '#f00'}" stroke-width="2"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`
                  ),
                  iconSize: [30, 30],
                  className: 'bounce'
                })
              }).bindPopup(i === 0 ? 'Start Point' : 'Destination');
            },
            addWaypoints: false
          }).addTo(this.map);

          this.routeControl.on('routesfound', (e) => {
            const route = e.routes[0];
            this.routeCoordinates = route.coordinates.map(coord => L.latLng(coord.lat, coord.lng));
            const km = (route.summary.totalDistance / 1000).toFixed(2);
            const timeMin = Math.ceil((route.summary.totalDistance / 1000) / speed * 60);
            console.log(`Route found: ${km} km, ${timeMin} minutes`);
            this.map.invalidateSize();
          });
        } catch (error) {
          console.error('Draw route error:', error);
        }
      },

      async connectMQTT() {
        const button = document.querySelector('#settings .primary');
        try {
          button.disabled = true;
          button.classList.add('loading');

          const config = {
            broker: document.getElementById('mqttBroker').value || 'wss://broker.hivemq.com',
            port: parseInt(document.getElementById('mqttPort').value) || 8884,
            topic: document.getElementById('mqttTopic').value || 'vehicles',
            username: document.getElementById('mqttUsername').value || undefined,
            password: document.getElementById('mqttPassword').value || undefined
          };

          this.mqttClient = mqtt.connect(config.broker, {
            port: config.port,
            username: config.username,
            password: config.password
          });

          this.mqttClient.on('connect', () => {
            this.mqttConnected = true;
            this.updateMQTTStatus();
            this.mqttClient.subscribe(config.topic + '/#', (err) => {
              if (err) {
                console.error('MQTT subscription error:', err);
                alert('Failed to subscribe to MQTT topic');
                return;
              }
              alert('MQTT connected successfully');
            });
          });

          this.mqttClient.on('message', (topic, message) => {
            try {
              const vehicleData = JSON.parse(message.toString());
              this.updateVehicleList({ [vehicleData.vehicleId]: vehicleData });
              this.updateVehicleMarkers({ [vehicleData.vehicleId]: vehicleData });
            } catch (err) {
              console.error('MQTT message parse error:', err);
            }
          });

          this.mqttClient.on('error', (err) => {
            this.mqttConnected = false;
            this.updateMQTTStatus();
            console.error('MQTT connection error:', err);
          });

          setInterval(() => this.refreshVehicles(), 5000);
        } catch (error) {
          alert('MQTT Connection Error: ' + error.message);
          console.error('MQTT connection error:', error);
        } finally {
          button.disabled = false;
          button.classList.remove('loading');
        }
      },

      updateMQTTStatus() {
        try {
          const statusElement = document.getElementById('mqttStatus').querySelector('span');
          statusElement.textContent = `MQTT: ${this.mqttConnected ? 'Connected' : 'Disconnected'}`;
          statusElement.className = this.mqttConnected ? 'mqtt-connected' : 'mqtt-disconnected';
        } catch (error) {
          console.error('Update MQTT status error:', error);
        }
      },

      async refreshVehicles() {
        try {
          const response = await fetch('http://localhost:8000/mqtt-status/');
          if (!response.ok) throw new Error('Failed to fetch vehicle data');
          const data = await response.json();

          this.mqttConnected = data.connected;
          this.updateMQTTStatus();
          this.updateVehicleList(data.vehicles);
          this.updateVehicleMarkers(data.vehicles);

          document.getElementById('activeVehicleCount').textContent = data.active_vehicles;
          document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        } catch (error) {
          console.error('Refresh vehicles error:', error);
        }
      },

      updateVehicleList(vehicles) {
        try {
          const vehicleList = document.getElementById('vehicleList');
          if (!Object.keys(vehicles).length) {
            vehicleList.innerHTML = '<div class="vehicle-item">No vehicles connected</div>';
            return;
          }

          let html = '';
          for (const [vehicleId, vehicleData] of Object.entries(vehicles)) {
            const status = vehicleData.status || 'unknown';
            const statusColor = status === 'available' ? '#0f0' :
                              status === 'in_transit' ? '#ff0' : '#f00';
            const statusClass = status === 'critical' ? 'pulse' : '';
            const ownership = vehicleData.ownership || 'military';
            const ownershipText = ownership === 'civilian' ? ' (Civilian)' : '';
            html += `
              <div class="vehicle-item">
                <div>
                  <strong>${this.escapeHTML(vehicleId)}${ownershipText}</strong><br>
                  <small>Type: ${this.escapeHTML(vehicleData.vehicleType || 'Unknown')}</small>
                </div>
                <div style="color: ${statusColor}; font-weight: bold;" class="${statusClass}">
                  ${this.escapeHTML(status.toUpperCase())}
                </div>
              </div>
            `;
          }
          vehicleList.innerHTML = html;
        } catch (error) {
          console.error('Update vehicle list error:', error);
        }
      },

      updateVehicleMarkers(vehicles) {
        try {
          for (const [vehicleId, vehicleData] of Object.entries(vehicles)) {
            if (vehicleData.lat && vehicleData.lng) {
              const ownership = vehicleData.ownership || 'military';
              const iconColor = ownership === 'civilian' ? '#999' : '#0f0';
              if (this.vehicleMarkers[vehicleId]) {
                this.vehicleMarkers[vehicleId].setLatLng([vehicleData.lat, vehicleData.lng]);
              } else {
                const marker = L.marker([vehicleData.lat, vehicleData.lng], {
                  icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(
                      `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2"><path d="M5 10h14l2-4H3l2 4zM5 10v4h14v-4M5 14l-2 4h18l-2-4M6 18a1 1 0 111-1 1 1 0 01-1 1zm12 0a1 1 0 111-1 1 1 0 01-1 1zM9 10l-1-4h8l-1 4"/></svg>`
                    ),
                    iconSize: [30, 30],
                    className: 'bounce'
                  })
                });

                marker.bindPopup(this.escapeHTML(`
                  <strong>${vehicleId}</strong><br>
                  Type: ${vehicleData.vehicleType || 'Unknown'}<br>
                  Ownership: ${ownership}<br>
                  Status: ${vehicleData.status || 'Unknown'}<br>
                  Speed: ${vehicleData.speed || 0} km/h<br>
                  Last Update: ${new Date(vehicleData.timestamp).toLocaleTimeString()}
                `));

                marker.addTo(this.map);
                this.vehicleMarkers[vehicleId] = marker;
              }
            }
          }
        } catch (error) {
          console.error('Update vehicle markers error:', error);
        }
      },

      async registerVehicle() {
        const button = document.querySelector('#vehicles button:last-child');
        try {
          button.disabled = true;
          button.classList.add('loading');

          const vehicleData = {
            vehicleId: document.getElementById('vehicleId').value,
            vehicleType: document.getElementById('vehicleType').value,
            capacity: parseInt(document.getElementById('vehicleCapacity').value) || 40,
            ownership: document.getElementById('ownership').value,
            currentLocation: [
              parseFloat(document.getElementById('vehicleLat').value) || 0,
              parseFloat(document.getElementById('vehicleLng').value) || 0
            ],
            status: 'available'
          };

          if (!vehicleData.vehicleId) throw new Error('Vehicle ID is required');
          if (vehicleData.currentLocation[0] === 0 || vehicleData.currentLocation[1] === 0) {
            throw new Error('Valid coordinates are required');
          }

          const response = await fetch('http://localhost:8000/register-vehicle/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(vehicleData)
          });

          if (!response.ok) throw new Error('Failed to register vehicle');
          const result = await response.json();

          if (result.status === 'success') {
            alert('Vehicle registered successfully');
            this.refreshVehicles();
            ['vehicleId', 'vehicleCapacity', 'vehicleLat', 'vehicleLng'].forEach(id => {
              document.getElementById(id).value = '';
            });
          }
        } catch (error) {
          alert('Error registering vehicle: ' + error.message);
          console.error('Vehicle registration error:', error);
        } finally {
          button.disabled = false;
          button.classList.remove('loading');
        }
      },

      async optimizeAllocation() {
        const button = document.querySelector('.action-buttons button:nth-child(2)');
        try {
          if (!this.activeRequests.length) {
            alert('No load requests to optimize');
            return;
          }

          button.disabled = true;
          button.classList.add('loading');

          const response = await fetch('http://localhost:8000/optimize-convoy/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(this.activeRequests.map(req => req.payload))
          });

          if (!response.ok) throw new Error('Optimization failed');
          const result = await response.json();

          let message = `Optimization Results:\n\n`;
          message += `Total Requests: ${result.total_requests}\n`;
          message += `Successful Allocations: ${result.allocations}\n\n`;

          result.details.forEach((allocation, index) => {
            message += `Request ${index + 1}: ${this.escapeHTML(allocation.status)}\n`;
            if (allocation.status === 'partial') {
              message += `Shortage: ${allocation.shortage} vehicles\n`;
            }
            message += `Vehicles Assigned: ${allocation.vehicles.length}\n\n`;
          });

          alert(message);
        } catch (error) {
          alert('Error optimizing allocation: ' + error.message);
          console.error('Optimization error:', error);
        } finally {
          button.disabled = false;
          button.classList.remove('loading');
        }
      },

      async generateMovementInstructions() {
        const button = document.querySelector('.action-buttons button:nth-child(3)');
        try {
          if (!this.activeRequests.length) {
            alert('No convoy requests available');
            return;
          }

          button.disabled = true;
          button.classList.add('loading');

          const convoy = {
            convoyId: 'CONV-' + Date.now(),
            vehicles: ['VEH-001', 'VEH-002'],
            route: [[28.6139, 77.2090], [28.7041, 77.1025]],
            priority: 'normal',
            loadType: 'cargo',
            estimatedDuration: 300
          };

          const response = await fetch('http://localhost:8000/generate-movement-instructions/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(convoy)
          });

          if (!response.ok) throw new Error('Failed to generate instructions');
          const result = await response.json();

          let instructions = `Movement Instructions for ${this.escapeHTML(result.convoy_id)}\n\n`;
          instructions += `Priority: ${this.escapeHTML(result.priority)}\n`;
          instructions += `Load Type: ${this.escapeHTML(result.load_type)}\n`;
          instructions += `Vehicle Count: ${result.vehicle_count}\n`;
          instructions += `Route Distance: ${result.route_distance.toFixed(2)} km\n`;
          instructions += `Estimated Duration: ${result.estimated_duration} minutes\n\n`;

          if (result.special_instructions?.length) {
            instructions += `Special Instructions:\n`;
            result.special_instructions.forEach(inst => {
              instructions += `• ${this.escapeHTML(inst)}\n`;
            });
            instructions += '\n';
          }

          if (result.fol_requirements?.overnight_camp) {
            instructions += `Overnight Camp: ${this.escapeHTML(result.fol_requirements.overnight_camp)}\n`;
          }

          alert(instructions);
        } catch (error) {
          alert('Error generating instructions: ' + error.message);
          console.error('Movement instructions error:', error);
        } finally {
          button.disabled = false;
          button.classList.remove('loading');
        }
      },

      async getConvoyTimeline() {
        const button = document.querySelector('#convoy button:nth-of-type(2)');
        try {
          const convoyId = document.getElementById('convoyId').value;
          if (!convoyId) {
            alert('Please enter a convoy ID');
            return;
          }

          button.disabled = true;
          button.classList.add('loading');

          const response = await fetch(`http://localhost:8000/convoy-timeline/${encodeURIComponent(convoyId)}`);
          if (!response.ok) throw new Error('Failed to fetch timeline');
          const result = await response.json();

          let timeline = `Timeline for ${this.escapeHTML(result.convoy_id)}:\n\n`;
          result.timeline.forEach(checkpoint => {
            timeline += `${this.escapeHTML(checkpoint.checkpoint)}: ${this.escapeHTML(checkpoint.eta)} (${this.escapeHTML(checkpoint.status)})\n`;
          });

          alert(timeline);
        } catch (error) {
          alert('Error getting timeline: ' + error.message);
          console.error('Timeline error:', error);
        } finally {
          button.disabled = false;
          button.classList.remove('loading');
        }
      },

      calculateVTKM() {
        try {
          const roadType = document.getElementById('roadType').value;
          const safetyDistance = parseInt(document.getElementById('safetyDistance').value) || 50;

          let vtkm;
          switch (roadType) {
            case 'mountain':
              vtkm = Math.floor(1000 / (25 + safetyDistance));
              break;
            case 'plains':
              vtkm = Math.floor(1000 / (20 + safetyDistance));
              break;
            case 'urban':
              vtkm = Math.floor(1000 / (15 + safetyDistance));
              break;
            default:
              vtkm = Math.floor(1000 / (20 + safetyDistance));
          }

          alert(`
            VTKM Result:
            Road Type: ${this.escapeHTML(roadType)}
            Safety Distance: ${safetyDistance}m
            Vehicles per Kilometer: ${vtkm}
          `);
        } catch (error) {
          console.error('Calculate VTKM error:', error);
        }
      },

      async showTransitCamps() {
        try {
          const response = await fetch('http://localhost:8000/transit-camps/');
          if (!response.ok) throw new Error('Failed to fetch transit camps');
          const result = await response.json();

          this.transitCampMarkers.forEach(marker => this.map.removeLayer(marker));
          this.transitCampMarkers = [];

          result.camps.forEach(camp => {
            const marker = L.marker(camp.coordinates, {
              icon: L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa(
                  '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#0f0" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'
                ),
                iconSize: [25, 25],
                className: 'bounce'
              })
            });

            marker.bindPopup(this.escapeHTML(`
              <strong>${camp.name}</strong><br>
              Capacity: ${camp.capacity}<br>
              Facilities: ${camp.facilities.join(', ')}<br>
              Coordinates: ${camp.coordinates[0].toFixed(4)}, ${camp.coordinates[1].toFixed(4)}
            `));

            marker.addTo(this.map);
            this.transitCampMarkers.push(marker);
          });

          alert(`${result.camps.length} transit camps displayed on map`);
        } catch (error) {
          alert('Error loading transit camps: ' + error.message);
          console.error('Transit camps error:', error);
        }
      },

      async showCheckpoints() {
        try {
          const response = await fetch('http://localhost:8000/checkpoints/');
          if (!response.ok) throw new Error('Failed to fetch checkpoints');
          const result = await response.json();

          this.tcpMarkers.forEach(marker => this.map.removeLayer(marker));
          this.tcpMarkers = [];

          result.checkpoints.forEach(tcp => {
            const marker = L.marker(tcp.coordinates, {
              icon: L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa(
                  '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#ff0" stroke-width="2"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>'
                ),
                iconSize: [25, 25],
                className: 'bounce'
              })
            });

            marker.bindPopup(this.escapeHTML(`
              <strong>TCP: ${tcp.name}</strong><br>
              Status: ${tcp.status}<br>
              Coordinates: ${tcp.coordinates[0].toFixed(4)}, ${tcp.coordinates[1].toFixed(4)}
            `));

            marker.addTo(this.map);
            this.tcpMarkers.push(marker);
          });

          alert(`${result.checkpoints.length} traffic checkpoints displayed on map`);
        } catch (error) {
          alert('Error loading checkpoints: ' + error.message);
          console.error('Checkpoints error:', error);
        }
      },

      async addTransitCamp() {
        try {
          const name = prompt('Enter transit camp name:');
          const capacity = prompt('Enter capacity:');
          const facilities = prompt('Enter facilities (comma-separated):');

          if (name && capacity && facilities) {
            const camp = {
              campId: 'TC-' + Date.now(),
              name,
              coordinates: [this.map.getCenter().lat, this.map.getCenter().lng],
              capacity: parseInt(capacity),
              facilities: facilities.split(',').map(f => f.trim())
            };

            const response = await fetch('http://localhost:8000/add-transit-camp/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(camp)
            });

            if (!response.ok) throw new Error('Failed to add transit camp');
            alert('Transit camp added successfully');
            this.showTransitCamps();
          }
        } catch (error) {
          alert('Error adding transit camp: ' + error.message);
          console.error('Add transit camp error:', error);
        }
      },

      async addCheckpoint() {
        try {
          const name = prompt('Enter checkpoint name:');
          const status = prompt('Enter status (operational/closed/congested):');

          if (name && status) {
            const tcp = {
              tcpId: 'TCP-' + Date.now(),
              name,
              coordinates: [this.map.getCenter().lat, this.map.getCenter().lng],
              status
            };

            const response = await fetch('http://localhost:8000/add-checkpoint/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(tcp)
            });

            if (!response.ok) throw new Error('Failed to add checkpoint');
            alert('Checkpoint added successfully');
            this.showCheckpoints();
          }
        } catch (error) {
          alert('Error adding checkpoint: ' + error.message);
          console.error('Add checkpoint error:', error);
        }
      },

      saveSettings() {
        try {
          const settings = {
            defaultSpeed: parseInt(document.getElementById('defaultSpeed').value) || 40,
            safetyDistance: parseInt(document.getElementById('safetyDistance').value) || 50
          };

          if (settings.defaultSpeed < 20 || settings.defaultSpeed > 80) {
            alert('Invalid speed (20-80 km/h)');
            return;
          }
          if (settings.safetyDistance < 10) {
            alert('Minimum safety distance is 10m');
            return;
          }

          localStorage.setItem('convoySettings', JSON.stringify(settings));
          alert('Settings saved successfully');
        } catch (error) {
          console.error('Save settings error:', error);
        }
      },

      loadSettings() {
        try {
          const settings = localStorage.getItem('convoySettings');
          if (settings) {
            const parsed = JSON.parse(settings);
            document.getElementById('defaultSpeed').value = parsed.defaultSpeed || 40;
            document.getElementById('safetyDistance').value = parsed.safetyDistance || 50;
          }
        } catch (error) {
          console.error('Load settings error:', error);
        }
      },

      escapeHTML(str) {
        return str.replace(/[&<>"']/g, m => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[m]);
      },

      async startConvoyTracking(convoyId) {
        try {
          const trackingInterval = setInterval(async () => {
            try {
              const response = await fetch(`http://localhost:8000/convoy-status/${encodeURIComponent(convoyId)}`);
              if (!response.ok) throw new Error('Failed to track convoy');
              const data = await response.json();

              if (data.status === 'completed' || data.status === 'cancelled') {
                clearInterval(trackingInterval);
                return;
              }

              this.updateConvoyPosition(data);
            } catch (error) {
              console.error('Convoy tracking error:', error);
            }
          }, 10000);
        } catch (error) {
          console.error('Start convoy tracking error:', error);
        }
      },

      updateConvoyPosition(convoyData) {
        try {
          convoyData.vehicles.forEach(vehicle => {
            if (this.vehicleMarkers[vehicle.id]) {
              const newLatLng = L.latLng(vehicle.currentLocation[0], vehicle.currentLocation[1]);
              this.vehicleMarkers[vehicle.id].setLatLng(newLatLng);
              this.vehicleMarkers[vehicle.id].setPopupContent(this.escapeHTML(`
                <strong>${vehicle.id}</strong><br>
                Status: ${vehicle.status}<br>
                Speed: ${vehicle.speed || 0} km/h<br>
                ETA: ${vehicle.eta || 'Calculating...'}<br>
                Last Update: ${new Date().toLocaleTimeString()}
              `));
            }
          });
        } catch (error) {
          console.error('Update convoy position error:', error);
        }
      },

      async getTrafficData(route) {
        try {
          const response = await fetch('http://localhost:8000/traffic-data/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ route })
          });
          if (!response.ok) throw new Error('Failed to fetch traffic data');
          return await response.json();
        } catch (error) {
          console.error('Traffic data error:', error);
          return null;
        }
      },

      async optimizeRoute(startCoords, endCoords, preferences = {}) {
        try {
          const payload = {
            start: startCoords,
            end: endCoords,
            preferences: {
              avoidTolls: preferences.avoidTolls || false,
              avoidHighways: preferences.avoidHighways || false,
              priority: preferences.priority || 'normal',
              vehicleType: preferences.vehicleType || 'truck'
            }
          };

          const response = await fetch('http://localhost:8000/optimize-route/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) throw new Error('Failed to optimize route');
          return await response.json();
        } catch (error) {
          console.error('Route optimization error:', error);
          return null;
        }
      },

      calculateFOLRequirements(distance, vehicleCount, vehicleTypes) {
        try {
          const fuelConsumption = {
            'bus': 6,
            'truck': 4,
            'troop_carrier': 5,
            'fuel_tanker': 3,
            'armored_truck': 2.5
          };

          let totalFuelRequired = 0;
          vehicleTypes.forEach(type => {
            const consumption = fuelConsumption[type] || 4;
            totalFuelRequired += (distance / consumption) * 1.2;
          });

          return {
            fuel_liters: Math.ceil(totalFuelRequired),
            oil_liters: Math.ceil(totalFuelRequired * 0.02),
            maintenance_stops: Math.ceil(distance / 500),
            estimated_cost: totalFuelRequired * 85
          };
        } catch (error) {
          console.error('Calculate FOL requirements error:', error);
          return null;
        }
      },

      async generateMovementOrder(convoyData) {
        try {
          const response = await fetch('http://localhost:8000/generate-movement-order/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(convoyData)
          });

          if (!response.ok) throw new Error('Failed to generate movement order');
          const movementOrder = await response.json();
          this.displayResult(movementOrder);
        } catch (error) {
          alert('Error generating movement order: ' + error.message);
          console.error('Movement order error:', error);
        }
      },

      suggestConvoyLayout() {
        try {
          if (!this.suggestedConvoy) {
            alert('No convoy suggested yet. Please process a load request first.');
            return;
          }

          const { vehiclesRequired, vehicleType } = this.suggestedConvoy;
          const safetyDistance = parseInt(document.getElementById('safetyDistance').value) || 50;
          const speed = parseFloat(document.getElementById('vehicleSpeed').value) || 40;

          let layoutHTML = `<strong>Suggested Convoy Layout:</strong><br>`;
          layoutHTML += `Number of Vehicles: ${vehiclesRequired}<br>`;
          layoutHTML += `Vehicle Type: ${vehicleType}<br>`;
          layoutHTML += `Inter-vehicle Distance: ${safetyDistance}m<br>`;
          layoutHTML += `Convoy Speed: ${speed} km/h<br>`;
          layoutHTML += `<br><strong>Convoy Order:</strong><br>`;
          layoutHTML += `1. Police Van (Front)<br>`;
          for (let i = 1; i <= vehiclesRequired; i++) {
            layoutHTML += `${i + 1}. ${vehicleType} (Load Vehicle)<br>`;
          }
          layoutHTML += `${vehiclesRequired + 2}. Police Van (Rear)<br>`;

          document.getElementById('layoutDisplay').innerHTML = layoutHTML;
        } catch (error) {
          console.error('Suggest convoy layout error:', error);
        }
      },

      sendNotifications(result) {
        try {
          const notificationData = {
            convoyId: 'CONV-' + Date.now(),
            priority: result.priority,
            vehiclesRequired: result.vehiclesRequired,
            folRequirements: this.calculateFOLRequirements(
              result.routeAnalysis?.distance_km || 100,
              result.vehiclesRequired || 4,
              [result.recommendedVehicleType || 'truck']
            )
          };

          console.log('Sending notifications:', notificationData);
          alert('Notifications sent for FOL requirements and TC intimations (simulated). Check console for details.');
        } catch (error) {
          console.error('Send notifications error:', error);
        }
      },

      init() {
        try {
          this.initMap();
          this.loadSettings();
          this.updateMQTTStatus();
          setInterval(() => this.refreshVehicles(), 30000);
          document.getElementById('systemStatus').textContent = 'Active';
          document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        } catch (error) {
          console.error('Initialization error:', error);
          alert('Failed to initialize system');
        }
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      try {
        ConvoySystem.init();

        document.getElementById('toggleControlPanel').addEventListener('click', () => {
          const controlPanel = document.querySelector('.control-panel');
          controlPanel.classList.toggle('hidden');
          const button = document.getElementById('toggleControlPanel');
          button.textContent = controlPanel.classList.contains('hidden') ? 'Show Control Panel' : 'Hide Control Panel';
          ConvoySystem.map.invalidateSize();
        });
      } catch (error) {
        console.error('DOM content loaded error:', error);
        alert('Failed to load application');
      }
    });
  </script>

  <script>
    if ('WebSocket' in window) {
      (function () {
        function refreshCSS() {
          var sheets = [].slice.call(document.getElementsByTagName("link"));
          var head = document.getElementsByTagName("head")[0];
          for (var i = 0; i < sheets.length; ++i) {
            var elem = sheets[i];
            var parent = elem.parentElement || head;
            parent.removeChild(elem);
            var rel = elem.rel;
            if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
              var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
              elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
            }
            parent.appendChild(elem);
          }
        }
        var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
        var address = protocol + window.location.host + window.location.pathname + '/ws';
        var socket = new WebSocket(address);
        socket.onmessage = function (msg) {
          if (msg.data == 'reload') window.location.reload();
          else if (msg.data == 'refreshcss') refreshCSS();
        };
        if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
          console.log('Live reload enabled.');
          sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
        }
      })();
    } else {
      console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
    }
  </script>
</body>
</html>
